# 梳理时钟约束

> 对时钟约束的归纳总结

## 一、时钟约束的概念

RTL只提供了逻辑设计，并不清楚实现过程中各个信号的要求。通过附加时序约束条件，让综合布局布线工具布置出符合时序要求的设计。

## 二、附加时序约束的过程

一般来说，时序约束一共包含以下三个步骤：**时钟约束、IO约束以及时序例外**。

附加时钟约束时首先定义设计的所有时钟，对各时钟域的同步元件进行分组，对分组附加周期约束，然后对FPGA输入输出PAD附加偏移约束、对组合逻辑PAD路径附加约束。附加专门约束时，首先约束分组之间的路径，然后约束快慢例外路径和多周期路径以及其他特殊路径。

### 1、附加全局约束

#### 1.1 全局时钟相关概念

**在FPGA设计中，FPGA全局时钟路径需要专用的时钟缓冲和驱动**，具有最小偏移和最大扇出能力，因此**最好的时钟方案是由专用的全局时钟输入引脚驱动的单个主时钟，去控制设计项目中的每一个触发器。**只要可能就应尽量在设计项目中采用全局时钟，因为对于一个设计项目来说，全局时钟是最简单和最可预测的时钟。

在ISE设计全局时钟时，IBUFG、BUFG、BUFGMUX等概念经常会被提及，这些资源可以统称为时钟资源，它们分为四类：全局时钟输入端口、全局时钟复用器、I/O时钟缓冲、水平时钟布线缓冲。下面挑选其中几个常见的资源种类，简单介绍下：

**IBUFG：**即输入全局缓冲，是与专用全局时钟输入管脚相连接的首级全局缓冲。所有从全局时钟管脚输入的信号必须经过IBUFG，否则在布局布线时会报错。IBUFG支持AGP、CTT、GTL、GTLP、HSTL、LVCMOS、LVDCI、LVDS、LVPECL、LVTTL、PCI、PCIX和SSTL等多种格式的I/O标准。

**IBUFGDS：**是IBUFG的差分形式，当信号从一对差分全局时钟管脚输入时，必须使用IBUFGDS作为全局时钟输入缓冲。IBUFG支持BLVDS、LDT、LVDSEXT、LVDS、LVPECL和ULVDS等多种格式的IO标准。

**BUFG：**是全局缓冲，它的输入是IBUFG的输出，BUFG的输出到达FPGA内部的IOB、CLB、选择性块RAM的时钟延迟和抖动最小。

**BUFGCE：**是带有时钟使能端的全局缓冲。它有一个输入I、一个使能端CE和一个输出端O。只有当BUFGCE的使能端CE有效(高电平)时，BUFGCE才有输出。

**BUFGMUX：**是全局时钟选择缓冲，它有I0和I1两个输入，一个控制端S，一个输出端O。当S为低电平时输出时钟为I0，反之为I1。需要指出的是BUFGMUX的应用十分灵活，I0和I1两个输入时钟甚至可以为异步关系。

**BUFGP：**相当于IBUG加上BUFG。

以上为常用的时钟资源，对于一般的全局时钟系统设计，有这些资源就足够了常用全局时钟系统

#### 1.2 常用结构

要组建一个全局时钟系统，首先要从全局时钟管脚输入一个时钟。有了这个时钟，就可以组建各种类型的全局时钟系统了。一般来说，常用的全局时钟系统有两种：**IBUFG+BUFG系统、IBUFG+DCM（PLL）+ BUFG。**

1. IBUFG+BUFG系统

   IBUFG+BUFG方案如下图所示，这也是最基本的全局时钟系统。将时钟管脚输入的时钟作为IBUFG的输入，然后将IBUFG的输出再作为BUFG的输入，则BUFG的输出即为得到的全局时钟。IBUFG+BUFG的方案相当于BUFGP。

   ![wMXbMn.png](https://s1.ax1x.com/2020/09/08/wMXbMn.png)

2. IBUFG+DCM（PLL）+BUFG

   平时用得最多的还是IBUFG+DCM（PLL）+BUFG方案，如下图所示。将时钟管脚输入的时钟作为IBUFG的输入，然后将IBUFG的输出作为DCM（PLL）的输入，将经DCM（PLL）频率变换后的输出再作为BUFG的输入这种方案使用方法最为灵活，对全局时钟的控制更加有效。通过DCM（PLL）模块不仅能对时钟进行同步、移相、分频、倍频等变换，而且可以使全局时钟的输出达到无抖动延迟（“0”skew）。

   ![wMj3eP.png](https://s1.ax1x.com/2020/09/08/wMj3eP.png)

### 2、四种基本时序路径

1. **Clock-to-Setup路径：**clock-to-setup路径从触发器的输入端开始，结束于下一级触发器，锁存器或者RAM的输入端，对终止端的数据信号要求一定的建立时间。
2. **Clock-to-pad路径：**Clock-to-Pad路径从寄存器或者锁存器的时钟输入端开始，终止于芯片的输出引脚，中间经过了触发器输出端以及所有的组合逻辑。
3. **Pad-to-Pad路径：**Pad-to-Pad路径从芯片输入信号端口开始，结束于芯片输出信号端口，中间包含所有组合逻辑，但并不包含任何同步逻辑。
4. **Pad-to-Setup路径：**Pad-to-setup路径从芯片的输入信号端口开始，结束于同步电路模块（触发器，锁存器和RAM），对相应的数据信号要求一定的建立时间

四个基本时序路径如下图所示

<img src="https://s1.ax1x.com/2020/09/08/wQSyu9.png" alt="wQSyu9.png" style="zoom:150%;" />

除了Pad-to-Pad路径是输入到输出其间没有锁存，其他三条都可以以2个时序单元路径进行分析。

其中 FPGA内部时序单元间的路径中，时序分析所需要的时间参数：Tclk-D1, Tclk-Q, Tdata_path_delay, Tclk_D2, Tsetup, Thold已能确定，只要属于FPGA内部的时间参数，Vivado则会根据相应设计计算得到，因此输入端口到输出端口的路径的时间参数也能确定。其它两条路径2和3都相应缺少FPGA外部的几个时间参数，这些参数都需要通过时序约束告知Vivado，然后Vivado才能精确地进行这些路径的时序分析。

### 3. 周期约束

对于上述需要时序约束的三种路径，Clock-to-Setup路径中的各个参数DC已经知道，所以需要定义关于时钟的信息。

周期约束也可以叫做时钟约束，其时钟可以分为**基本时钟，虚拟时钟，生成时钟**三种。

clk0的时钟属性：周期为10ns，占空比为50%，相移为0ns；（相移也可以用°来表示，例如相移位0°，相移为90°等）

clk1的时钟属性：周期为8ns，占空比为75%，相移为2ns；（相移为2ns，也就是相移为90°。

<img src="https://s1.ax1x.com/2020/09/08/wQF3cT.png" alt="wQF3cT.png" style="zoom:150%;" />

1. 基本时钟

   一个基本时钟是指PCB上的时钟，它通过下面方式输入设计中：

   - 一个输入端口；

   - 一个吉比特收发器输出引脚。

   下面给出一个基本时钟例子：

   在这个例子中，通过名字为“sysclk”的端口，将PCB上的时钟引入FPGA元器件中，并且通过输入缓冲器和一个时钟缓冲器，最终到达路径上的寄存器。该时钟的属性为：周期为10ns，占空比为50%，无相移。

   <img src="https://s1.ax1x.com/2020/09/08/wQFO5n.png" alt="wQFO5n.png" style="zoom:150%;" />

   在Xilinx设计约束中（XDC），将该时钟约束表示为：

   create_clock -period 10 [get_ports sysclk]

   若该时钟属性为：周期为10ns，占空比为25%，相移为90°。则在XDC，将时钟约束表示为

   create_clock -period 10 -waveform{2.5 5} [get_ports sysclk]