---
layout:     post
title:      硬件架构的艺术阅读笔记
subtitle:   Using Guide
date:       2021-08-01
author:     MZ
header-img: img/post-bg-artreading.jpg
catalog: true
tags:
    - Reading Note

---



# 硬件架构的艺术阅读笔记

> From 2021.06.29

## 第一章 亚稳态的世界

- **亚稳态发生原因**：数据信号在触发器时钟上升沿附近（**建立和保持时间之内**）变化。**并非所有**不满足建立和保持时间的输入变化都会导致亚稳态的发生。触发器是否进入亚稳态和返回稳态所需要时间**取决于生产器件的工艺技术与外界环境**。一般来说，触发器会在**一个或者两个**时钟内返回稳态。

  > 简单来说，一个信号在一个时钟域里变化，在另一个时钟域内采样时（异步设计），就大概率会导致输出变成亚稳态，这就是所谓的同步失败。

- **亚稳态窗口（Metastability Windows）**：亚稳态窗口具有特定的时间长度，在这段时间内输入信号和时钟都应该保持不变，否则可能产生亚稳态。建立时间和保持时间共同决定亚稳态窗口的宽度。

- **平均无故障时间（MTBF Mean/Average Time Between Failures）**：当系统故障率稳定时，平均无故障时间为故障率倒数。
- **MTBF计算**：对于一个具有给定时钟频率和在该时钟周期内具有均匀概率密度的异步数据信号边沿的单级同步器，亚稳态事件的发生概率可以用**亚稳态窗口和时钟周期的比值乘以信号触发频率**来计算。

$$
\frac{1}{故障率}=\mathrm{MTBF_{1} }  =\frac{e(t_{\tau}/\tau )}{Wf_{c} f_{d} }
$$

​		两级同步器下的MTBF可用如下式计算：
$$
\frac{1}{故障率}=\mathrm{MTBF_{2} }  =\frac{e(t_{\tau1}/\tau )}{Wf_{c} f_{d} }\times e(t_{\tau2}/\tau)
$$

- **可能出现违背时序要求的情况**：

  - 输入信号是异步信号。（信号变化与时钟无关）
  - 时钟偏移/摆动（上升/下降时间）高于容限值。
  - 信号在两个不同频率或者相同频率但是相位和偏移不同的时钟域下跨时钟域工作。
  - 组合延迟使触发器的数据输入在亚稳态窗口内发生变化。

- **单bit下降低亚稳态发生概率的方法**：
  - 使用多级同步器：在跨时钟域的信号上加上一个或者多个同步触发器，但该方法增加了观察同步逻辑输入的延迟。
  - 时钟倍频的多级同步器：该方法为Altera的专利，就是利用倍频的时钟作为两个同步触发器的时钟输入，让系统在一个系统时钟周期内响应一个异步输入，但是两级触发器的偏移量会变大。

  该两种方法均不能避免亚稳态的发生和传播，只能降低概率。

- **亚稳态测试电路**：使用上升沿D触发器，输入一个异步信号。再下降沿D触发器（捕捉亚稳态状态），将D触发器的输出Q端分别输入D触发器和经过一个非门输入D触发器，之后输出两个D触发器异或非，如果输出为1，则说明发生了亚稳态。

<img src="https://gitee.com/xmzcool/bloglmage/raw/master/img/2020040319213588.png" alt="img" style="zoom:80%;" />

- **同步器类型**：

  > 书中原文不解：“一个异步信号不应该被两个或者多个同步器所同步（这样做会存在多级同步器输出产生不同信号的风险）”

  - 两级同步寄存器的模式A：当异步输入信号比时钟周期大得多时有效。

    ![两级同步器](https://gitee.com/xmzcool/bloglmage/raw/master/img/20200403192532712.png)

  - 两级同步寄存器的模式B：书中图不明确。

  - **当信号必须跨时钟域工作时，要采用同步器**。

- **亚稳态综合型建议**：

  1. 采用同步器。
  2. 采用响应更快的触发器（缩短亚稳态窗口）。
  3. 使用亚稳态硬化触发器。
  4. 使用多级触发器级联，降低亚稳态发生概率。
  5. 减小采样率。
  6. 避免使用dV/dt (电压上升速率)低的输入信号。

## 第二章 时钟和复位 

- 经验表明，ASIC的时域控制最安全的方法就是同步设计（由单个主时钟和复位/置位信号驱动设计中的所有时序器件）。

- 避免使用行波计数器（用触发器的输出来驱动其他触发器的时钟端）。会出现因触发器时钟到q端的延时积累，触发器将不同步。

  ![image-20210713225726803](https://gitee.com/xmzcool/bloglmage/raw/master/img/image-20210713225726803.png)

- 在时钟线上的门控单元会导致时钟偏移，并会引入尖峰脉冲作用于触发器。在时钟线上存在组合逻辑时，这个问题尤为严重。含门控时钟的设计在仿真时可能很正常，但是在综合时可能会出现问题。

  ![image-20210713230457303](https://gitee.com/xmzcool/bloglmage/raw/master/img/image-20210713230457303.png)

- 所有内部逻辑生成的时钟都应同步后输出。

- 行波计数器常用作进行幂为2的分频，应注意这种方法会引入延时，每次分频会出现新的时钟域，设计时应考虑延时的影响。

  > 行波计数器可以做低功耗设计。

  <img src="https://gitee.com/xmzcool/bloglmage/raw/master/img/image-20210801153448440.png" alt="image-20210801153448440" style="zoom:80%;" />

  <img src="https://gitee.com/xmzcool/bloglmage/raw/master/img/image-20210801153530976.png" alt="image-20210801153530976" style="zoom:80%;" />

- 时钟的MUX需要满足如下要求：

  - 在初始化后，多路时钟操作就不再改变。
  - 在测试时，设计会绕过功能时钟多路逻辑而选择普通时钟。
  - 在时钟切换时，寄存器始终处于复位状态。
  - 在时钟切换时产生的短暂错误响应没有负面影响。

- 同步设计中，时钟带来的功耗主要分为三个部分：

  - 在每个时钟沿变化的组合逻辑所产生的功耗（由于触发器驱动这些组合逻辑）。
  - 由触发器所产生的功耗（即使触发器的输入和内部状态未改变，该功耗仍然存在）。
  - 设计中时钟树所产生的功耗（消耗了整个芯片功耗的50%）。

  > 因此，门控时钟会带来功耗的较大减小，并且尽量在时钟树根部做门控。

- 门控时钟

  - 时钟组合逻辑做门控时钟时，必须要保证在时钟不活跃期间使能（时钟为0且无跳变时），因此出现了带锁存器的门控时钟设计。

  - 基于锁存器的门控时钟电路：

    <img src="https://gitee.com/xmzcool/bloglmage/raw/master/img/image-20210801192659874.png" alt="image-20210801192659874" style="zoom:80%;" />

    与门对应上升沿有效时钟，或门与正沿触发的锁存器对应下降沿有效时钟。

    > 使用这一技术时，必须特别注意时钟的占空比以及产生使能信号逻辑的延迟，因为使能信号必须在半时钟周期时产生。

- 好的设计会在没有明确要求的情况下为SOC中的每个触发器都提供复位信号。在某种情况下，当流水线的寄存器在高速应用中使用时，应该去掉某些寄存器的复位信号，以使设计达到更高性能。

- 由于复位数的高扇出，复位相对于时钟周期可能是一个“迟到的信号”。及时复位信号经过了复位缓冲树的缓冲，也要尽可能减少其到达本地逻辑前穿过的逻辑数量。

- 使用同步复位的**优点**：

  1. 同步复位一般能确保电路是100%同步的。
  2. *同步复位会综合为更小的触发器，特别是在该复位信号被触发器的输入逻辑门控时。*
  3. 同步复位可以作为过滤复位毛刺的手段，**尤其有些复位信号是由组合逻辑生成的时候。**

- 使用同步复位的**缺点**：

  1. 同步复位可能需要一个脉冲展宽器（用一个小计数器），以保证复位信号能出现在时钟有效沿。
  2. 究其本质，同步复位需要时钟信号参与，若使用门控时钟时容易出问题，复位信号出发时时钟可能关闭。此时只能使用异步复位，并在时钟恢复前消除复位信号。
  3. 使用同步复位很有可能在数据通路中添加额外的逻辑路径，可能会影响设计时序。

- 使用异步复位的**优点**：

  1. 只要生产方的库中有带异步复位的触发器cell，在综合时就能保证逻辑路径干净。
  2. 另一个优势在于**不管电路有没有**时钟都可以复位。

- 使用异步复位的**缺点**：

  1. 在DFT中，如果复位信号不能直接被IO引脚驱动，就必须将异步复位线路与复位驱动器断开以保证DFT扫描和测试的正确。

     > ![image-20210808202245612](https://gitee.com/xmzcool/bloglmage/raw/master/img/image-20210808202245612.png)

  2. 异步复位在撤销时，如果发生在时钟的有效沿附近时，触发器的输出有可能产生亚稳态。

  3. 异步复位的毛刺可能会引发伪复位，需要设计人员设计毛刺过滤器来消除复位电路上的毛刺。

  4. 对于同步复位和异步复位，复位树必须是时间可控的，以确保复位能在一个时钟周期内释放，要解决这个问题的一种方法是使用分布式复位同步触发器（异步复位同步释放）。

     > *时钟复位时序是否和setup与hold时间相同？

- 异步复位对毛刺敏感，为解决这个问题，可以在复位源头加入毛刺滤除模块。此外，复位pad也应该采用施密特触发器。

  ![preview](https://pic3.zhimg.com/v2-b2d8c341b69cf11f59eb0a7ef8f0df8a_r.jpg)

- 异步复位的release如果不满足寄存器的recover和removal要求可能导致寄存器在不同时钟周期解复位或者寄存器输出亚稳态的问题。如图所示使用复位同步器进行异步复位同步解复位可以解决异步复位release的时序问题。

  ![preview](https://pic4.zhimg.com/v2-a672eecbc01b31e72275b21afe0898df_r.jpg)

  复位同步器的第二级肯定不存在亚稳态问题，这是因为第二级寄存器的D和Q在复位信号变化时均是0。

- 短路径问题：在两个相邻触发器之间的数据传播延迟比时钟偏移还短，就会出现该问题。这会使两个触发器输出同样的数据。解决该问题的最好方式是将始终偏移减至最小，将设计中的时钟偏移保持在触发器的最小延迟之下，能提高设计对所有短路径问题的健壮性。

- 常见增强短路径问题健壮性的方法：

  1. 在数据路径上加入延迟，保证数据路径延迟一定大于时钟偏移。
  2. 时钟反转，插入足够的延时使得接收触发器比源触发器先接收时钟有效沿。
  3. 交替相位时钟，顺序上相邻的触发器时钟相反的时钟沿进行触发。
  4. 使用行波时钟结构。

